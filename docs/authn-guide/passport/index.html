<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Passport - Gluu Docs</title>
      
<link href="../../assets/stylesheets/font.css" rel="stylesheet">
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Gluu Docs">
    <meta property="og:image" content="None/../../gluu.jpg">
    <meta name="apple-mobile-web-app-title" content="Gluu Docs">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
      <link rel="apple-touch-icon" href="../../gluu.jpg">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-gluu.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-gluu.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-f58e216493.css">
    
    <link rel="stylesheet" href="../../assets/stylesheets/zenburn-28d5b94970.css">
    
      
      
      
      <link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto Sans:400,700|Source+Code+Pro">
      <style>
        body, input {
          font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
    <script src="../../assets/javascripts/modernizr-4a5cc7e01e.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Administration Guide <i class="icon icon-link"></i>
              
            
              
                User Authentication Guide <i class="icon icon-link"></i>
              
            
          </span>
        
        Passport
      </div>
    </div>
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" placeholder="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">

  
  <a href="https://github.com/GluuFederation/docs-3" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../gluu.jpg">
        </div>
      
      <div class="name">
        <strong>Gluu Docs</strong><br>
        version: 3.0.0
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      <ul class="repo">
        
        <li class="home">
          <a href="/" title="Home">
            <div class="home-image">
            <i class="fa fa-home"></i> Doc Home</div>
          </a>
        </li>
        
        
        
        <li class="repo-download">
          
          <a href="https://github.com/GluuFederation/docs-3/archive/3.0.0.zip" target="_blank" title="Download" data-action="download">
            <i class="icon icon-download"></i> Download
          </a>
        </li>
        
      </ul>
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="../..">
      Home
    </a>
    
  </li>
                  
          
            
  <li>
    <a class="" title="Whats new in 3.0" href="../../operation/intro/">
      Whats new in 3.0
    </a>
    
  </li>
                  
          
            
  <li>
    <span class="section">Installation Guide</span>
    <ul>
      
        
  <li>
    <a class="" title="Preparing VM" href="../../installation-guide/">
      Preparing VM
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Install Gluu Server" href="../../installation-guide/install/">
      Install Gluu Server
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Setup Script Options" href="../../installation-guide/setup_py/">
      Setup Script Options
    </a>
    
  </li>
                  
      
    </ul>
  </li>
                  
          
            
  <li>
    <span class="section">Upgrade/Patch Guide</span>
    <ul>
      
        
  <li>
    <a class="" title="Updating oxTrust" href="../../upgrade/update-oxtrustwar/">
      Updating oxTrust
    </a>
    
  </li>
                  
      
    </ul>
  </li>
                  
          
            
  <li>
    <span class="section">Administration Guide</span>
    <ul>
      
        
  <li>
    <a class="" title="oxTrust admin UI" href="../../admin-guide/oxtrust-ui/">
      oxTrust admin UI
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Authentication Management" href="../../admin-guide/auth-management/">
      Authentication Management
    </a>
    
  </li>
                  
      
        
  <li>
    <span class="section">User Authentication Guide</span>
    <ul>
      
        
  <li>
    <a class="" title="User Authentication Introduction" href="../../admin-guide/user-authentications/">
      User Authentication Introduction
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="U2f" href="../U2F/">
      U2f
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="DUO" href="../DUO/">
      DUO
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="oxPush2-Super Gluu" href="../supergluu/">
      oxPush2-Super Gluu
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="certificate Authentication" href="../cert-auth/">
      certificate Authentication
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Google" href="../google/">
      Google
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Custom Script Authentication" href="../customauthn/">
      Custom Script Authentication
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="current" title="Passport" href="./">
      Passport
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Overview" href="#overview">
                <b>Overview</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="Why Passport.js Authenticaion" href="#why-passportjs-authenticaion">
                <b>Why Passport.js Authenticaion</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="Specifications" href="#specifications">
                <b>Specifications</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="Sequence Diagram" href="#sequence-diagram">
                <b>Sequence Diagram</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="SETUP Passport.js with Gluu" href="#setup-passportjs-with-gluu">
                <b>SETUP Passport.js with Gluu</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="How to create a new app to use for Passport server?" href="#how-to-create-a-new-app-to-use-for-passport-server">
                <b>How to create a new app to use for Passport server?</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="INSTALLATION" href="#installation">
                <b>INSTALLATION</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="JWT" href="#jwt">
                <b>JWT</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="Example of encoded and decoded JWT" href="#example-of-encoded-and-decoded-jwt">
                <b>Example of encoded and decoded JWT</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="What data will be persist?" href="#what-data-will-be-persist">
                <b>What data will be persist?</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="How Node-Passport server will fit in Gluu server?" href="#how-node-passport-server-will-fit-in-gluu-server">
                <b>How Node-Passport server will fit in Gluu server?</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="How does Gluu server specify which passport strategy it wants?" href="#how-does-gluu-server-specify-which-passport-strategy-it-wants">
                <b>How does Gluu server specify which passport strategy it wants?</b>
              </a>
            </li>
            
          
            <li class="anchor">
              <a title="How to add new strategies to Passport server?" href="#how-to-add-new-strategies-to-passport-server">
                <b>How to add new strategies to Passport server?</b>
              </a>
            </li>
            
              <li class="anchor">
              <a title="Configure the strategy" href="#configure-the-strategy">
                  <font size=2><i>Configure the strategy</i></font>
              </a>
            </li>
             
              <li class="anchor">
              <a title="Configure routes for the strategy" href="#configure-routes-for-the-strategy">
                  <font size=2><i>Configure routes for the strategy</i></font>
              </a>
            </li>
             
              <li class="anchor">
              <a title="Call method to configure the strategy" href="#call-method-to-configure-the-strategy">
                  <font size=2><i>Call method to configure the strategy</i></font>
              </a>
            </li>
             
              <li class="anchor">
              <a title="Add button for the configured strategy in passport authentication UI." href="#add-button-for-the-configured-strategy-in-passport-authentication-ui">
                  <font size=2><i>Add button for the configured strategy in passport authentication UI.</i></font>
              </a>
            </li>
             
          
        </ul>
      
    
  </li>
                  
      
        
  <li>
    <a class="" title="HOTP/TOTP" href="../otp/">
      HOTP/TOTP
    </a>
    
  </li>
                  
      
    </ul>
  </li>
                  
      
        
  <li>
    <a class="" title="User Management" href="../../admin-guide/user-group/">
      User Management
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Log Management" href="../../admin-guide/logs/">
      Log Management
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="OpenID Clients" href="../../admin-guide/clients/">
      OpenID Clients
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="SAML SSO" href="../../admin-guide/saml/">
      SAML SSO
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="OpenID Connect" href="../../admin-guide/openid-connect/">
      OpenID Connect
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="UMA" href="../../admin-guide/uma/">
      UMA
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Attribute Management" href="../../admin-guide/attribute/">
      Attribute Management
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="SCIM protected by UMA" href="../../admin-guide/scim-uma/">
      SCIM protected by UMA
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Gluu Server APIs" href="../../admin-guide/api/">
      Gluu Server APIs
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="SCIM API Configuration" href="../../admin-guide/scim/">
      SCIM API Configuration
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Backup Gluu Server CE" href="../../admin-guide/backup/">
      Backup Gluu Server CE
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Custom Script in Gluu CE" href="../../admin-guide/custom-script/">
      Custom Script in Gluu CE
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Certificate Management" href="../../admin-guide/certificate/">
      Certificate Management
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="FAQ & Troubleshooting" href="../../admin-guide/faq/">
      FAQ & Troubleshooting
    </a>
    
  </li>
                  
      
    </ul>
  </li>
                  
          
            
  <li>
    <span class="section">Integration Guide</span>
    <ul>
      
        
  <li>
    <a class="" title="Shibboleth SP" href="../../integration/saml-sp/">
      Shibboleth SP
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Mod auth OpenID" href="../../integration/openidc-rp/">
      Mod auth OpenID
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="OXD OAuth2" href="../../integration/oauth2/">
      OXD OAuth2
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Google SSO" href="../../integration/google/">
      Google SSO
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Office 365" href="../../integration/office/">
      Office 365
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Salesforce" href="../../integration/salesforce/">
      Salesforce
    </a>
    
  </li>
                  
      
        
  <li>
    <a class="" title="Dropbox" href="../../integration/dropbox/">
      Dropbox
    </a>
    
  </li>
                  
      
    </ul>
  </li>
                  
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="passportjs-authentication">Passport.js Authentication<a class="headerlink" href="#passportjs-authentication" title="Permanent link">#</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">#</a></h2>
<p>Passport is authentication middleware for Node.js. Extremely flexible and modular, Passport can be unobtrusively dropped in to any Express-based web application. Including Passport.js in the Gluu Server will allow an admin to offer many authentication strategies to end users, including social login at large consumer IDPs like Google, Facebook, etc.</p>
<h2 id="why-passportjs-authenticaion">Why Passport.js Authenticaion<a class="headerlink" href="#why-passportjs-authenticaion" title="Permanent link">#</a></h2>
<ul>
<li>To create Node-Passport server which will provide social network authentication APIs for Gluu server.</li>
<li>To create Gluu server interception scripts for authentication of users which will consume Node-Passport server api.</li>
</ul>
<h2 id="specifications">Specifications<a class="headerlink" href="#specifications" title="Permanent link">#</a></h2>
<p>Node-Passport server authenticates users for all the social networks like: google+, facebook, twitter etc. Node-Passport uses passport authentication middleware for social network authentication. All the node js api are secured with JWT(JSON Web Token) so that all the requests to node js server are authenticated and can be trusted by the application.</p>
<p>Gluu server has only one interception script for all the social network providers which will call node js server for authenticating users to respective social network provider. The users will be added to Gluu server if the user does not present in the LDAP server of Gluu and if user does not exists then user will be added to server.</p>
<h2 id="sequence-diagram">Sequence Diagram<a class="headerlink" href="#sequence-diagram" title="Permanent link">#</a></h2>
<p><img alt="Sequence Diagram" src="../../img/user-authn/passport/sequence_diagram.png" title="Title" /></p>
<ol>
<li>Gluu server calls Node-Passport server for JWT token.</li>
<li>Node-Passport server generates a JWT token and provides it in response to Gluu server.</li>
<li>Gluu server requests Node-Passport server with JWT token to authenticate user for a social network provider.</li>
<li>Node-Passport server will redirect user to social media authentication provider.</li>
<li>After successful authentication of user, social network will callback Node-Passport server along with user details and access token.</li>
<li>Node-Passport server will redirect user back to Gluu server with user details and access token.</li>
<li>Gluu server’s interception script will check if the user exists in LDAP server and if user exists then user will be logged into the system and if not, then it will create new user with the required details and logs user into the system.</li>
</ol>
<h2 id="setup-passportjs-with-gluu">SETUP Passport.js with Gluu<a class="headerlink" href="#setup-passportjs-with-gluu" title="Permanent link">#</a></h2>
<p>During installation of the Gluu Server select <code>yes</code> to install Passport.js when prompted.</p>
<ol>
<li>Click on Manage Custom Scripts under configuration tab on the main menu.</li>
<li>Enable passport script in Person Authentication Tab.<img alt="Enable passport1" src="../../img/user-authn/passport/enable-passport.png" /></li>
<li>Click on update at the end of the page.<img alt="update" src="../../img/user-authn/passport/auth-update.png" /></li>
<li>Enable uma authorization policy in uma authorization policy tab.<img alt="uma-enable" src="../../img/user-authn/passport/uma-enable.png" /></li>
<li>Click on update.</li>
<li>To set the strategies from Configuration &gt; Manage Authentication &gt; Default Authenticaion</li>
<li>Under Default Authenticaion tab, change Authentication mode to passport</li>
<li>Change passport support to enabled.<img alt="enable-authentication" src="../../img/user-authn/passport/enable-authentication.png" /></li>
<li>Once Passport support is enabled and updated, Passport Authentication Method will appear in the next tab.</li>
<li>Click on the Passport Authenticaion Method, and set the strategies as follows,The values for Strategy field for common providers are:<ul>
<li>google for GPlus Authentication</li>
<li>twitter for Twitter Authentication</li>
<li>linkedin for LinkedIn Authentication</li>
<li>github for Github Authentication</li>
<li>facebook for Facebook Authentication</li>
</ul>
</li>
<li>And then add the strategy details like clientID and clientSecret.
            clientID and clientSecret are details obtained from the provider, after the app is created in the provider form.<img alt="setting-strategies" src="../../img/user-authn/passport/setting-strategies.png" /></li>
<li>Once the configuration and settings are done, restart the passport service or Gluu Server.
        a. Login to chroot
        b. Enter below command to stop.
        <code>service passport stop</code>
        c. Below command to start.
        <code>service passport start</code></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>All the strategies name and Field name should follow the case. As these are case sensitive. ie. Google Strategy should have "google" as the strategy name and clientID should be small "c".</p>
</div>
<h2 id="how-to-create-a-new-app-to-use-for-passport-server">How to create a new app to use for Passport server?<a class="headerlink" href="#how-to-create-a-new-app-to-use-for-passport-server" title="Permanent link">#</a></h2>
<p>Every provider has different protocols and ways to create the app. We will look at one of the most common providers "facebook" and create a new app.</p>
<ol>
<li>Login to https://developers.facebook.com</li>
<li>Click on Add a new App from My Apps dropdown</li>
<li>Fill the required details and click the create Create App ID button to create the app.</li>
<li>Click on the dashboard menu and get the clientID and clientSecret which can be used with the passport.</li>
<li>Click on settings menu and put the domain of your gluu server in the App Domains field.</li>
</ol>
<p>Note: If there is a filed for Authorized redirect URIs, make sure the Authorized redirect URIs list of your app contains the passport strategy's callback. If your gluu server points to https://example.gluu.org and the strategy is facebook, the list of Authorized redirect URIs should contain https://example.gluu.org/passport/auth/facebook/callback.
Make sure the  Authorized redirect URIs list of your app contains the passport strategy's callback.
If your gluu server points to https://example.gluu.org and the strategy is facebook, the list of Authorized redirect URIs should contain https://example.gluu.org/passport/auth/facebook/callback.</p>
<h2 id="installation">INSTALLATION<a class="headerlink" href="#installation" title="Permanent link">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The node installation is already installed when passport is selected during the installation of Gluu 3.0.0 CE Server.</p>
</div>
<p>Node-Passport server requires npm and NodeJS to be installed on the system.</p>
<p>For installing node and npm please refer to <a href="https://nodejs.org/en/download/package-manager/">this guide</a>.</p>
<p>Clone the repository and move to server directory and hit:</p>
<p><code>npm install</code></p>
<p>This will install all the dependencies of the server. To start the server move to the server directory and hit</p>
<p><code>node app</code></p>
<h2 id="jwt">JWT<a class="headerlink" href="#jwt" title="Permanent link">#</a></h2>
<p>JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with HMAC algorithm) or a public/private key pair using RSA.</p>
<p>JSON Web Tokens consist of three parts separated by dots (.), which are:
- Header
- Payload
- Signature</p>
<p>Therefore, a JWT typically looks like the following.
xxxxx.yyyyy.zzzzz</p>
<p>All the three parts are then Base64Url encoded to form JSON Web Token.</p>
<p>The output is three Base64 strings separated by dots that can be easily passed in HTML and HTTP environments, while being more compact compared to XML-based standards such as SAML.</p>
<p>The following shows a JWT that has the previous header and payload encoded, and it is signed with a secret.</p>
<p>If you want to play with JWT and put these concepts to practice, you can use jwt.io Debugger to decode, verify and generate JWTs.</p>
<h2 id="example-of-encoded-and-decoded-jwt">Example of encoded and decoded JWT<a class="headerlink" href="#example-of-encoded-and-decoded-jwt" title="Permanent link">#</a></h2>
<p><img alt="JWT" src="../../img/user-authn/passport/jwt.png" title="Title" /></p>
<p>Whenever the user wants to access a protected route or resource, it should send the JWT, here in our case in route url. Therefore the route or api call should look like the following.</p>
<p>https://urltorouteorresource/JWT</p>
<p>This is a stateless authentication mechanism as the user state is never saved in the server memory. The server's protected routes will check for a valid JWT in the API parameter, and if there is a valid token, the user will be allowed.</p>
<h2 id="what-data-will-be-persist">What data will be persist?<a class="headerlink" href="#what-data-will-be-persist" title="Permanent link">#</a></h2>
<p>All the data that are received from the social network like name, email etc will be stored. If all the required details for creating a user are not available from the social network then user will be asked to enter all the required details. Currently email is the only required field.</p>
<h2 id="how-node-passport-server-will-fit-in-gluu-server">How Node-Passport server will fit in Gluu server?<a class="headerlink" href="#how-node-passport-server-will-fit-in-gluu-server" title="Permanent link">#</a></h2>
<p>During the installation of Gluu server we can setup node server as well. We can create a vagrant script to set up whole Node-Passport environment.</p>
<h2 id="how-does-gluu-server-specify-which-passport-strategy-it-wants">How does Gluu server specify which passport strategy it wants?<a class="headerlink" href="#how-does-gluu-server-specify-which-passport-strategy-it-wants" title="Permanent link">#</a></h2>
<p>There will be single page for the authentication with different buttons which will call different endpoints on Node-Passport server. For example twitter button will call the twitter strategy of Node-Passport server for twitter authentication.</p>
<h2 id="how-to-add-new-strategies-to-passport-server">How to add new strategies to Passport server?<a class="headerlink" href="#how-to-add-new-strategies-to-passport-server" title="Permanent link">#</a></h2>
<p>Find an npm module that fits best for the strategy that you want to add.
Let's start with an example. In this example we will consider adding facebook strategy.</p>
<ol>
<li>If you want to add facebook strategy, search for passport-facebook npm module where you can select the npm module and then add the module to passport server.</li>
<li>Let's say we found this module "passport-facebook" and want to use this module in for facebook authentication, install the module in passport app by executing <code>npm install passport-facebook --save</code> to install the module and also save the dependency to the passport server.</li>
<li>Configure the strategy.</li>
<li>Configure routes for the strategy.</li>
<li>Call method to configure the strategy</li>
<li>Add button for the configured strategy in passport authentication UI.</li>
</ol>
<h5 id="configure-the-strategy">Configure the strategy<a class="headerlink" href="#configure-the-strategy" title="Permanent link">#</a></h5>
<p>All the strategies are been configured in the folder server/auth/*.js.
We need to create new file named with the strategy name. Our strategy is facebook so we can create new file named facebook.js and configure the strategy.</p>
<pre><code class="javascript">var passport = require('passport');
var FacebookStrategy = require('passport-facebook').Strategy;

var setCredentials = function(credentials) {
    var callbackURL = global.applicationHost.concat(&quot;/passport/auth/facebook/callback&quot;);
    passport.use(new FacebookStrategy({
            clientID: credentials.clientID,
            clientSecret: credentials.clientSecret,
            callbackURL: callbackURL,
            enableProof: true,
            profileFields: ['id', 'name', 'displayName', 'email']
        },
        function(accessToken, refreshToken, profile, done) {
            var userProfile = {
                id: profile._json.id,
                name: profile.displayName,
                username: profile.username || profile._json.id,
                email: profile._json.email,
                givenName: profile._json.first_name,
                familyName: profile._json.last_name,
                provider: profile.provider,
                accessToken: accessToken
            };
            return done(null, userProfile);
        }
    ));
};

module.exports = {
    passport: passport,
    setCredentials: setCredentials
};
</code></pre>

<p>Here is an example of the facebook strategy configured. For facebook the required parameters are clientID, clientSecret and callbackURL. You can search for more configurations depending on the requirements and configure accordingly.</p>
<p>The function setCredentials is used to configure the strategy of the credentials of this strategy are been received. The parameter credentials holds the values that are stored in the oxTrust</p>
<p>The parameter callbackURL should point to the callback route that we will configure in step 4. As we are configuring facebook strategy, the callbackURL can be set to <code>"/passport/auth/facebook/callback"</code> according the the convention of the app. You can customise the callbackURL but it is recommended not to change the convention.</p>
<p>The callback function has different number of parameters and data in those parameters which are required to be mapped to the userProfile keys which are <code>id, name, username, email, givenName, familyName, provider, accessToken</code>. Here id and provider params are must. Provider param holds the value of the provider, i.e for facebook the provider value will be facebook etc. In most cases the value of provider is received in the user claims itself.</p>
<p>Then export the strategy that we configured and also the setCredentials method which will be used to set the details of the strategy.</p>
<h5 id="configure-routes-for-the-strategy">Configure routes for the strategy<a class="headerlink" href="#configure-routes-for-the-strategy" title="Permanent link">#</a></h5>
<p>We are going to set the routes for the strategy that we are going to configure.
First require the strategy that we configured in the previous step.</p>
<pre><code class="javascript">var passportFacebook = require('../auth/facebook').passport;
</code></pre>

<p>Here <code>require('../auth/facebook').passport</code> will include the passport strategy that we have configured.</p>
<p>Then add the routes for the strategy. First we are going to register the callback route and then the authenticate route.</p>
<p>The authenticate route first validated the jwt token that is been sent by Gluu server to passport server. If the JWT is valid then the user is redirected to the strategy and user can be authenticated there and the response of the user authentication is redirected to callback route.</p>
<p>If the callback routes receives the user data then user is been redirected to Gluu.</p>
<pre><code class="javascript">//==================== facebook ================
router.get('/auth/facebook/callback',
    passportFacebook.authenticate('facebook', {
        failureRedirect: '/passport/login'
    }),
    callbackResponse);

router.get('/auth/facebook/:token',
    validateToken,
    passportFacebook.authenticate('facebook', {
        scope: ['email']
    }));
</code></pre>

<p>scope value can be set from the strategy itself it it supports that or you can set the scope value here too.</p>
<p>The callbackResponse method return the control to Gluu server and user is been enrolled in the system.</p>
<h5 id="call-method-to-configure-the-strategy">Call method to configure the strategy<a class="headerlink" href="#call-method-to-configure-the-strategy" title="Permanent link">#</a></h5>
<p>In this step we are going to call the setCredentials method of the strategy that we have created.</p>
<p>Go to the file configureStrategies.js in auth folder of passport server and require the strategy that we have created.</p>
<pre><code class="javascript">var FacebookStrategy = require('./facebook');
</code></pre>

<p>And then in setConfiguratins function, call the setCredentials method if the strategy data is received.</p>
<pre><code class="javascript">//FacebookStrategy
if (data.passportStrategies.facebook) {
    logger.log('info', 'Facebook Strategy details received');
    logger.sendMQMessage('info: Facebook Strategy details received');
    FacebookStrategy.setCredentials(data.passportStrategies.facebook);
}
</code></pre>

<p>This will configure the passport strategy if the details of the strategy are received from passport API.</p>
<h5 id="add-button-for-the-configured-strategy-in-passport-authentication-ui">Add button for the configured strategy in passport authentication UI.<a class="headerlink" href="#add-button-for-the-configured-strategy-in-passport-authentication-ui" title="Permanent link">#</a></h5>
<p>So far the passport server is ready with the new strategy that we have created, but to call the strategy we need to add a button which calls the new strategy.</p>
<pre><code class="xhtml">&lt;a data-p=&quot;facebook&quot; class=&quot;provider&quot; href=&quot;javascript:void(0);&quot; style=&quot;height:40px; width:120px&quot;&gt;
    &lt;img alt=&quot;facebook&quot; src=&quot;img/facebook.png&quot; style=&quot;height:40px; width:40px&quot;&gt;&lt;/img&gt;
&lt;/a&gt;
</code></pre>

<p>Here the data-p and class="provider" are required to call the strategy. the data-p attribute should hold the value of the route that we created in routes.</p>
<pre><code class="javascript">//==================== facebook ================
router.get('/auth/facebook/callback',
    passportFacebook.authenticate('facebook', {
        failureRedirect: '/passport/login'
    }),
    callbackResponse);

router.get('/auth/facebook/:token',
    validateToken,
    passportFacebook.authenticate('facebook', {
        scope: ['email']
    }));
</code></pre>

<p>In order to call the Strategy, the request URL to call the API must match the route that we configured.</p>
          <aside class="copyright" role="note">
           Built with 
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a> using
            <a href="http://gitlab.testbird.io:8099/frontend/testbird-mkdocs-theme.git" target="_blank">
              testBird-mkdocs-theme
            </a> <br>
            
            Copyright &copy; 2016, Gluu, Inc.
            
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../customauthn/" title="Custom Script Authentication">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Custom Script Authentication
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../otp/" title="HOTP/TOTP">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                HOTP/TOTP
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = '';
    </script>
    <script src="../../assets/javascripts/application-ce3999cf34.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    
  </body>
</html>